model NivelInvestigador {
  id                String      @id @default(cuid())
  codigo            String      @unique @map("codigo")
  nombre            String      @map("nombre")
  descripcion       String      @map("descripcion")
  puntajeMinimo     Int         @map("puntaje_minimo")
  puntajeMaximo     Int         @map("puntaje_maximo")
  color             String      @map("color")
  icono             String?     @map("icono")
  orden             Int         @map("orden")
  activo            Boolean     @default(true) @map("activo")
  requisitos        Json?       @map("requisitos")
  beneficios        Json?       @map("beneficios")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt      @map("updated_at")
  investigadores    Profile[]
  evaluaciones      Evaluacion[]

  /// Niveles válidos para 'codigo' y 'nombre':
  /// - CANDIDATO: Candidato a Investigador Estatal
  /// - NIVEL_I: Investigador Estatal Nivel I
  /// - NIVEL_II: Investigador Estatal Nivel II
  /// - NIVEL_III: Investigador Estatal Nivel III
  /// - EXCEPCIONAL: Investigador Excepcional
  /// - INSIGNE: Investigador Insigne
  ///
  /// Descripciones:
  /// - Investigador: Persona que realiza actividades sistemáticas para generar conocimiento nuevo o aplicar conocimientos existentes en beneficio de la sociedad.
  /// - Candidato a Investigador Estatal: Personas con nivel mínimo de licenciatura que realizan actividades de producción científica, divulgación y promoción científica, adscritos a instituciones académicas o tecnológicas.
  /// - Investigador Estatal Nivel I: Profesionales con grado de maestría o estudiantes de doctorado que colaboran en proyectos de investigación, desarrollo tecnológico y/o innovación.
  /// - Investigador Estatal Nivel II: Investigadores con grado de doctorado hayan liderado proyectos científicos o tecnológicos con impacto en el estado y que sean miembros del SNII.
  /// - Investigador Estatal Nivel III: Miembros del Sistema Nacional de Investigadores (SNI) en el nivel II, con alto impacto en el estado.
  /// - Investigador Excepcional: Miembros del SNI en los niveles III o Emérito, reconocidos por su trayectoria científica y tecnológica como referentes estatales en su área de conocimiento, con más de 10 años de experiencia en el proceso ID+i.
  /// - Investigador Insigne: Distinción otorgada a aquellos investigadores que han alcanzado el más alto nivel de reconocimiento en su trayectoria científica, tecnológica y académica, con un impacto significativo en su área de conocimiento y en la sociedad.

  @@map("niveles_investigador")
}
model Evaluacion {
  id                    String              @id @default(cuid())
  investigadorId        String              @map("investigador_id")
  evaluadorId           String              @map("evaluador_id")
  evaluadorNombre       String              @map("evaluador_nombre")
  nivelPropuestoId      String              @map("nivel_propuesto_id")
  ciclo                 String              @map("ciclo")
  puntajePublicaciones  Int                 @default(0) @map("puntaje_publicaciones")
  puntajeProyectos      Int                 @default(0) @map("puntaje_proyectos")
  puntajeFormacion      Int                 @default(0) @map("puntaje_formacion")
  puntajeExperiencia    Int                 @default(0) @map("puntaje_experiencia")
  puntajeImpacto        Int                 @default(0) @map("puntaje_impacto")
  puntajeTotal          Int                 @default(0) @map("puntaje_total")
  detallePublicaciones  Json?               @map("detalle_publicaciones")
  detalleProyectos      Json?               @map("detalle_proyectos")
  detalleFormacion      Json?               @map("detalle_formacion")
  detalleExperiencia    Json?               @map("detalle_experiencia")
  detalleImpacto        Json?               @map("detalle_impacto")
  observaciones         String?             @map("observaciones")
  fortalezas            String?             @map("fortalezas")
  areasMejora           String?             @map("areas_mejora")
  documentosSoporte     Json?               @map("documentos_soporte")
  estado                String              @default("EN_REVISION") @map("estado")
  aprobadoPor           String?             @map("aprobado_por")
  fechaAprobacion       DateTime?           @map("fecha_aprobacion")
  fechaInicio           DateTime            @default(now()) @map("fecha_inicio")
  fechaFinalizacion     DateTime?           @map("fecha_finalizacion")
  investigador          Profile             @relation(fields: [investigadorId], references: [id])
  nivelPropuesto        NivelInvestigador   @relation(fields: [nivelPropuestoId], references: [id])
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt      @map("updated_at")
}

model MetricaInvestigador {
  id String @id @default(cuid())
  investigadorId String @unique @map("investigador_id")
  investigador Profile @relation(fields: [investigadorId], references: [id])

  publicaciones        Int      @default(0) @map("publicaciones")
  articulos            Int      @default(0) @map("articulos")
  libros               Int      @default(0) @map("libros")
  capitulosLibro       Int      @default(0) @map("capitulos_libro")
  ponencias            Int      @default(0) @map("ponencias")
  patentes             Int      @default(0) @map("patentes")
  proyectos            Int      @default(0) @map("proyectos")
  tesisDirigidas       Int      @default(0) @map("tesis_dirigidas")
  premios              Int      @default(0) @map("premios")
  estancias            Int      @default(0) @map("estancias")
  colaboraciones       Int      @default(0) @map("colaboraciones")
  evaluacionesRecibidas Int     @default(0) @map("evaluaciones_recibidas")
  evaluacionesRealizadas Int    @default(0) @map("evaluaciones_realizadas")
  indiceH              Float?   @map("indice_h")
  indiceG              Float?   @map("indice_g")
  citasTotales         Int      @default(0) @map("citas_totales")
  impactoSocial        String?  @map("impacto_social")
  fechaUltimaActualizacion DateTime @default(now()) @map("fecha_ultima_actualizacion")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt      @map("updated_at")
}
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id         String    @id @default(cuid())
  email      String    @unique
  password   String
  roleId     String
  lastActive DateTime? @default(now())
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  profile    Profile?
  role       Role      @relation(fields: [roleId], references: [id])

  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]

  @@map("roles")
}

model Profile {
  id                  String       @id @default(cuid())
  userId              String?      @unique         @map("user_id")
  clerkUserId         String?      @unique         @map("clerk_user_id")
  slug                String?      @unique         @map("slug")
  nombreCompleto      String                        @map("nombre_completo")
  nombres             String?                       @map("nombres")
  apellidos           String?                       @map("apellidos")
  curp                String?      @unique         @map("curp")
  rfc                 String?                       @map("rfc")
  noCvu               String?                       @map("no_cvu")
  correo              String?                       @map("correo")
  telefono            String?                       @map("telefono")
  fotografiaUrl       String?                       @map("fotografia_url")
  nacionalidad        String?      @default("Mexicana") @map("nacionalidad")
  fechaNacimiento     DateTime?                    @map("fecha_nacimiento")
  genero              String?                       @map("genero")
  municipio           String?                       @map("municipio")
  estadoNacimiento    String?                       @map("estado_nacimiento")
  entidadFederativa   String?                       @map("entidad_federativa")
  institucionId       String?                       @map("institucion_id")
  institucion         String?                       @map("institucion")
  departamento        String?                       @map("departamento")
  ubicacion           String?                       @map("ubicacion")
  sitioWeb            String?                       @map("sitio_web")
  origen              String?                       @map("origen")
  archivoProcesado    String?                       @map("archivo_procesado")
  fechaRegistro       DateTime?   @default(now())  @map("fecha_registro")
  isAdmin             Boolean?    @default(false)  @map("es_admin")
  activo              Boolean?    @default(true)   @map("activo")

  // Académico y profesional
  ultimoGradoEstudios String?                       @map("ultimo_grado_estudios")
  gradoMaximoEstudios String?                       @map("grado_maximo_estudios")
  empleoActual        String?                       @map("empleo_actual")
  lineaInvestigacion  String?                       @map("linea_investigacion")
  areaInvestigacion   String?                       @map("area_investigacion")
  disciplina          String?                       @map("disciplina")
  especialidad        String?                       @map("especialidad")
  orcid               String?                       @map("orcid")
  nivel               String?                       @map("nivel")
  nivelInvestigador   String?                       @map("nivel_investigador")
  nivelActualId       String?                       @map("nivel_actual_id")
  fechaAsignacionNivel DateTime?                    @map("fecha_asignacion_nivel")
  puntajeTotal        Int?         @default(0)      @map("puntaje_total")
  estadoEvaluacion    String?      @default("PENDIENTE") @map("estado_evaluacion")

  // Producción y experiencia
  articulos                   String? @map("articulos")
  libros                      String? @map("libros")
  capitulosLibros             String? @map("capitulos_libros")
  proyectosInvestigacion      String? @map("proyectos_investigacion")
  proyectosVinculacion        String? @map("proyectos_vinculacion")
  experienciaDocente          String? @map("experiencia_docente")
  experienciaLaboral          String? @map("experiencia_laboral")
  premiosDistinciones         String? @map("premios_distinciones")
  idiomas                     String? @map("idiomas")
  colaboracionInternacional   String? @map("colaboracion_internacional")
  colaboracionNacional        String? @map("colaboracion_nacional")
  sni                         String? @map("sni")
  anioSni                     Int?    @map("anio_sni")
  cvUrl                       String? @map("cv_url")
  dictamenUrl                 String? @map("dictamen_url")

  institucionRel      Institution? @relation(fields: [institucionId], references: [id])
  user                User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  nivelActual         NivelInvestigador? @relation(fields: [nivelActualId], references: [id])
  evaluaciones        Evaluacion[]
  certificados        Certificado[]
  metricas            MetricaInvestigador?
  // postulaciones       Postulacion[] // Comentado hasta que se implemente la tabla
  mensajesEnviados      Mensaje[]  @relation("MensajesEnviados")
  mensajesRecibidos     Mensaje[]  @relation("MensajesRecibidos")
  conexionesIniciadas   Conexion[] @relation("ConexionesIniciadas")
  conexionesRecibidas   Conexion[] @relation("ConexionesRecibidas")
  conexionesDestino     Conexion[] @relation("ConexionesDestino")
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt      @map("updated_at")

  tipoPerfil           String?   @default("INVESTIGADOR") @map("tipo_perfil") // "INVESTIGADOR" o "TECNOLOGO"
  nivelTecnologoId     String?   @map("nivel_tecnologo_id")
  nivelTecnologoTexto  String?   @map("nivel_tecnologo")
  nivelTecnologoRelacion NivelTecnologo? @relation(fields: [nivelTecnologoId], references: [id])

  @@map("investigadores")
}

model NivelTecnologo {
  id          String   @id @default(cuid())
  codigo      String   @unique @map("codigo") // "A" o "B"
  nombre      String   @map("nombre")
  descripcion String   @map("descripcion")
  perfiles    Profile[]

  /// Niveles válidos:
  /// - A: Tecnólogo Nivel A
  ///   Estudiantes o egresados recientes de licenciaturas en áreas de humanidades, ciencias, tecnología e innovación, con experiencia en proyectos iniciales de desarrollo tecnológico, adscritos a empresas, instituciones académicas o centros de investigación.
  /// - B: Tecnólogo Nivel B
  ///   Profesionales con experiencia comprobable en el desarrollo tecnológico o la innovación en las áreas de humanidades, ciencias, tecnología e innovación, adscritos a empresas, instituciones de educación superior, centros de investigación, o entidades equivalentes. Incluye a quienes cuenten con títulos de propiedad industrial otorgados por el IMPI.

  @@map("niveles_tecnologo")
}

model Institution {
  id        String    @id @default(cuid())
  nombre    String
  siglas    String?
  tipo      String?
  tipoOtroEspecificar String? @map("tipo_otro_especificar")
  añoFundacion Int? @map("año_fundacion")
  sitioWeb  String? @map("sitio_web")
  imagenUrl String? @map("imagen_url")
  descripcion String? @db.Text
  
  // Régimen fiscal
  tipoPersona String? @map("tipo_persona") // "fisica" | "moral"
  rfc String?
  razonSocial String? @map("razon_social") @db.Text
  regimenFiscal String? @map("regimen_fiscal")
  actividadEconomica String? @map("actividad_economica") @db.Text
  
  // Persona física específicos
  curp String?
  nombreCompleto String? @map("nombre_completo")
  
  // Persona moral específicos
  numeroEscritura String? @map("numero_escritura")
  fechaConstitucion DateTime? @map("fecha_constitucion")
  notarioPublico String? @map("notario_publico")
  numeroNotaria String? @map("numero_notaria")
  registroPublico String? @map("registro_publico")
  objetoSocial String? @map("objeto_social") @db.Text
  
  // Domicilio fiscal (JSON)
  domicilioFiscal Json? @map("domicilio_fiscal")
  
  // Representante legal (JSON - solo persona moral)
  representanteLegal Json? @map("representante_legal")
  
  // Contacto institucional (JSON)
  contactoInstitucional Json? @map("contacto_institucional")
  
  // Áreas de investigación (JSON array)
  areasInvestigacion Json? @map("areas_investigacion")
  
  // Capacidad de investigación
  capacidadInvestigacion String? @map("capacidad_investigacion") @db.Text
  
  // Documentos (JSON con URLs)
  documentos Json?
  
  // Estado y ubicación
  ubicacion String?
  activo Boolean @default(true)
  estado String? @default("PENDIENTE") // PENDIENTE, APROBADA, RECHAZADA
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  profiles  Profile[]

  @@map("institutions")
}

model Certificado {
  id                    String              @id @default(cuid())
  folio                 String              @unique // SEI-2025-000123
  investigadorId        String
  nivelId               String?             // Nivel al momento de emisión

  // Datos del certificado (snapshot)
  nombreCompleto        String

  curp                  String
  nivel                 String
  nivelDescripcion      String?

  // Fechas
  fechaEmision          DateTime            @default(now())
  fechaVigenciaInicio   DateTime
  fechaVigenciaFin      DateTime

  // Archivos generados
  pdfUrl                String?             // URL del PDF en Cloudinary
  qrCodeUrl             String?             // URL del QR code

  // Verificación
  codigoVerificacion    String              @unique // Hash SHA-256
  verificado            Boolean             @default(false)
  vecesVerificado       Int                 @default(0)
  ultimaVerificacion    DateTime?

  // Estado
  estado                String              @default("ACTIVO")
  // Estados: ACTIVO, REVOCADO, EXPIRADO, SUSPENDIDO
  motivoRevocacion      String?
  fechaRevocacion       DateTime?
  revocadoPor           String?             // ClerkID

  // Firma digital
  firmadoPor            String?             // Nombre del funcionario
  cargoFirmante         String?
  firmaDigital          String?             // Hash de la firma

  // Metadata
  plantillaUsada        String?             // ID de plantilla
  metadataAdicional     Json?               // Información adicional

  investigador          Profile             @relation(fields: [investigadorId], references: [id])
  verificaciones        VerificacionCertificado[]

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([investigadorId])
  @@index([folio])
  @@index([estado])
  @@index([codigoVerificacion])
  @@map("certificados")
}

model VerificacionCertificado {
  id                String      @id @default(cuid())
  certificadoId     String
  folio             String
  ipAddress         String?
  userAgent         String?
  pais              String?
  ciudad            String?
  exitosa           Boolean     @default(true)
  motivoFallo       String?
  fechaVerificacion DateTime    @default(now())

  certificado       Certificado @relation(fields: [certificadoId], references: [id])

  @@index([certificadoId])
  @@index([fechaVerificacion])
  @@map("verificaciones_certificado")
}

  model PlantillaCertificado {
    id              String   @id @default(cuid())
    nombre          String
    descripcion     String?
    htmlTemplate    String   @db.Text // HTML del certificado
    cssStyles       String?  @db.Text // Estilos CSS
    variables       Json?    // Variables disponibles {nombre, placeholder, tipo}
  
    // Configuración
    orientacion     String   @default("portrait") // portrait, landscape
    tamano          String   @default("letter")   // letter, a4
    margenes        Json?    // {top, right, bottom, left}
  
    // Estado
    activa          Boolean  @default(false)
    version         Int      @default(1)
  
    // Metadata
    creadaPor       String?
    ultimaEdicion   String?
  
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt
  
    @@map("plantillas_certificado")
  }

  // ========================================
  // MÓDULO 3: CONVOCATORIAS
  // ========================================

  model Convocatoria {
    id                    String              @id @default(cuid())
    titulo                String
    organizacion          String?
    descripcion           String?
    fechaInicio           DateTime            @map("fechaInicio")
    fechaCierre           DateTime            @map("fechaCierre")
    montoMaximo           String?
    categoria             String?
    pdfUrl                String?             @map("pdfUrl")
    estado                String              @default("Abierta")
    createdAt             DateTime            @default(now()) @map("createdAt")
    updatedAt             DateTime            @updatedAt @map("updatedAt")
  
    @@map("convocatorias")
  }

  // Modelos relacionados con convocatorias (comentados porque aún no están implementados en la BD)
  // Estos modelos se pueden descomentar cuando se implementen las funcionalidades completas
  
  // model Postulacion {
  //   id                    String              @id @default(cuid())
  //   convocatoriaId        String
  //   investigadorId        String
  //   folio                 String              @unique // POST-2025-000123
  //   convocatoria          Convocatoria        @relation(fields: [convocatoriaId], references: [id])
  //   investigador          Profile             @relation(fields: [investigadorId], references: [id])
  //   createdAt             DateTime            @default(now())
  //   updatedAt             DateTime            @updatedAt
  //   @@map("postulaciones")
  // }

  // model EvaluacionPostulacion {
  //   id                    String      @id @default(cuid())
  //   postulacionId         String
  //   postulacion           Postulacion @relation(fields: [postulacionId], references: [id])
  //   createdAt             DateTime    @default(now())
  //   updatedAt             DateTime    @updatedAt
  //   @@map("evaluaciones_postulacion")
  // }

  // model CicloConvocatoria {
  //   id                String      @id @default(cuid())
  //   nombre            String      @unique
  //   createdAt         DateTime    @default(now())
  //   updatedAt         DateTime    @updatedAt
  //   @@map("ciclos_convocatoria")
  // }

  // model NotificacionConvocatoria {
  //   id                String      @id @default(cuid())
  //   convocatoriaId    String?
  //   createdAt         DateTime    @default(now())
  //   updatedAt         DateTime    @updatedAt
  //   @@map("notificaciones_convocatoria")
  // }

  // ========================================
  // MENSAJERÍA Y CONEXIONES
  // ========================================

model Mensaje {
  id              String   @id @default(cuid())
  remitenteId     String   @map("remitente_id")
  destinatarioId  String   @map("destinatario_id")
  asunto          String?  @db.VarChar(255)
  contenido       String   @db.Text
  leido           Boolean  @default(false)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  remitente       Profile  @relation("MensajesEnviados", fields: [remitenteId], references: [id], onDelete: Cascade)
  destinatario    Profile  @relation("MensajesRecibidos", fields: [destinatarioId], references: [id], onDelete: Cascade)
  
  @@index([destinatarioId])
  @@index([leido])
  @@map("mensajes")
}

model Conexion {
  id                    String   @id @default(cuid())
  investigadorId        String   @map("investigador_id")
  conectadoConId        String   @map("conectado_con_id")
  investigadorDestinoId String   @map("investigador_destino_id")
  estado                String   @default("pendiente") @db.VarChar(50)
  mensaje               String?  @db.Text
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  
  investigador          Profile  @relation("ConexionesIniciadas", fields: [investigadorId], references: [id], onDelete: Cascade)
  conectadoCon          Profile  @relation("ConexionesRecibidas", fields: [conectadoConId], references: [id], onDelete: Cascade)
  investigadorDestino   Profile  @relation("ConexionesDestino", fields: [investigadorDestinoId], references: [id], onDelete: Cascade)
  
  @@unique([investigadorId, conectadoConId])
  @@index([estado])
  @@index([investigadorDestinoId])
  @@map("conexiones")
}

  // ========================================
  // ÍNDICES ADICIONALES PARA OPTIMIZACIÓN
  // ========================================

  // Los índices ya están definidos en cada modelo con @@index
  // Esto mejora el rendimiento de queries frecuentes

